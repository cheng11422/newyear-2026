<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 æ–°å¹´çƒŸèŠ±</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #000;
            font-family: 'Microsoft YaHei', sans-serif;
            color: white;
        }
        canvas {
            display: block;
            cursor: pointer;
        }
        /* æ§åˆ¶é¢æ¿ - å“åº”å¼è®¾è®¡ */
        .control-panel {
            position: fixed;
            bottom: 10px;
            left: 10px;
            right: 10px;
            z-index: 100;
            background: rgba(0, 0, 0, 0.9);
            padding: 12px;
            border-radius: 10px;
            border: 2px solid rgba(255, 215, 0, 0.5);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            max-width: 400px;
            margin: 0 auto;
        }
        @media (min-width: 768px) {
            .control-panel {
                left: 20px;
                right: auto;
                width: 280px;
                bottom: 20px;
            }
        }
        .panel-title {
            color: #FFD700;
            font-size: 14px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: bold;
        }
        .music-info {
            margin-bottom: 8px;
            padding: 6px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            font-size: 12px;
        }
        .music-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-bottom: 8px;
        }
        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 6px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            font-weight: bold;
            min-height: 32px;
        }
        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .control-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
            opacity: 0.6;
        }
        .control-btn.green {
            background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
        }
        .control-btn.red {
            background: linear-gradient(135deg, #f44336 0%, #c62828 100%);
        }
        .control-btn.blue {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        .music-time {
            text-align: center;
            margin: 6px 0;
            font-size: 12px;
            color: #FFD700;
        }
        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 6px;
            vertical-align: middle;
        }
        .status-offline {
            background: #f44336;
            box-shadow: 0 0 8px #f44336;
        }
        .status-loading {
            background: #ff9800;
            box-shadow: 0 0 8px #ff9800;
            animation: pulse 1s infinite;
        }
        .status-ready {
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }
        .status-playing {
            background: #2196F3;
            box-shadow: 0 0 8px #2196F3;
            animation: pulse 0.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .upload-help {
            margin-top: 10px;
            padding: 8px;
            background: rgba(255, 215, 0, 0.05);
            border-radius: 5px;
            border: 1px dashed rgba(255, 215, 0, 0.3);
            font-size: 10px;
            line-height: 1.3;
        }
        .upload-help a {
            color: #4CAF50;
            text-decoration: none;
        }
        .upload-help a:hover {
            text-decoration: underline;
        }
        .mobile-warning {
            display: none;
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            padding: 8px;
            border-radius: 5px;
            font-size: 11px;
            text-align: center;
            border: 1px solid rgba(255, 215, 0, 0.5);
            z-index: 101;
        }
        @media (max-width: 480px) {
            .mobile-warning {
                display: block;
            }
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<div class="mobile-warning">
    ğŸ’¡ æç¤ºï¼šç‚¹å‡»å±å¹•ä»»æ„ä½ç½®æ’­æ”¾éŸ³ä¹å’Œæ”¾çƒŸèŠ±ï¼
</div>

<div class="control-panel">
    <div class="panel-title">ğŸµ æ–°å¹´éŸ³ä¹æ§åˆ¶å° ğŸ†</div>
    
    <div class="music-info">
        <span id="statusIndicator" class="status-indicator status-offline"></span>
        <span id="musicStatus">éŸ³ä¹ç³»ç»Ÿç¦»çº¿</span>
    </div>
    
    <div class="music-time" id="musicTime">--:-- / 02:50</div>
    
    <div class="music-buttons">
        <button class="control-btn green" onclick="playMusic()" id="playBtn">â–¶ï¸ æ’­æ”¾</button>
        <button class="control-btn red" onclick="pauseMusic()" id="pauseBtn" disabled>â¸ï¸ æš‚åœ</button>
        <button class="control-btn" onclick="tryLocalFile()" id="localBtn">ğŸ“ æœ¬åœ°</button>
        <button class="control-btn blue" onclick="useOnlineMusic()" id="onlineBtn">ğŸŒ åœ¨çº¿</button>
    </div>
    
    <div class="upload-help">
        <strong>éŸ³ä¹æ–‡ä»¶é—®é¢˜ï¼Ÿ</strong><br>
        æ£€æŸ¥æ–‡ä»¶åï¼šnewyear-music.mp3<br>
        <a href="https://github.com/cheng11422/newyear-2026/upload/main" target="_blank">é‡æ–°ä¸Šä¼ æ–‡ä»¶</a>
    </div>
</div>

<script>
    // ====== éŸ³ä¹é…ç½® ======
    const MUSIC_CONFIG = {
        localFiles: [
            'newyear-music.mp3',
            './newyear-music.mp3',
            '/newyear-music.mp3',
            'music.mp3',
            'song.mp3'
        ],
        onlineSources: [
            'https://assets.mixkit.co/music/preview/mixkit-happy-new-year-2026-1098.mp3',
            'https://assets.mixkit.co/music/preview/mixkit-celebration-time-571.mp3',
            'https://assets.mixkit.co/music/preview/mixkit-party-happy-people-428.mp3'
        ]
    };
    
    // ====== çŠ¶æ€ç®¡ç† ======
    const state = {
        music: null,
        isPlaying: false,
        currentSource: null,
        currentTime: 0,
        duration: 170, // 2åˆ†50ç§’
        volume: 0.7
    };
    
    // ====== DOM å…ƒç´  ======
    const elements = {
        statusIndicator: document.getElementById('statusIndicator'),
        musicStatus: document.getElementById('musicStatus'),
        musicTime: document.getElementById('musicTime'),
        playBtn: document.getElementById('playBtn'),
        pauseBtn: document.getElementById('pauseBtn'),
        localBtn: document.getElementById('localBtn'),
        onlineBtn: document.getElementById('onlineBtn')
    };
    
    // ====== çŠ¶æ€æ›´æ–°å‡½æ•° ======
    function updateStatus(status, message) {
        elements.statusIndicator.className = 'status-indicator ' + status;
        elements.musicStatus.textContent = message;
    }
    
    function updateButtons() {
        elements.playBtn.disabled = !state.music || state.isPlaying;
        elements.pauseBtn.disabled = !state.music || !state.isPlaying;
    }
    
    function updateTime() {
        if (!state.music) return;
        
        const current = Math.floor(state.music.currentTime);
        const total = state.duration;
        
        if (current >= total) {
            pauseMusic();
            state.music.currentTime = 0;
        }
        
        const formatTime = (seconds) => {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };
        
        elements.musicTime.textContent = `${formatTime(current)} / ${formatTime(total)}`;
    }
    
    // ====== éŸ³ä¹æ§åˆ¶å‡½æ•° ======
    function createAudioPlayer(src) {
        // æ¸…ç†æ—§çš„éŸ³é¢‘
        if (state.music) {
            state.music.pause();
            state.music = null;
        }
        
        updateStatus('status-loading', 'åŠ è½½éŸ³ä¹ä¸­...');
        
        const audio = new Audio();
        audio.src = src;
        audio.volume = state.volume;
        audio.preload = 'auto';
        
        audio.addEventListener('canplaythrough', () => {
            updateStatus('status-ready', 'éŸ³ä¹å‡†å¤‡å°±ç»ª');
            state.currentSource = src;
            updateButtons();
        });
        
        audio.addEventListener('play', () => {
            state.isPlaying = true;
            updateStatus('status-playing', 'æ­£åœ¨æ’­æ”¾...');
            updateButtons();
            startTimeUpdater();
        });
        
        audio.addEventListener('pause', () => {
            state.isPlaying = false;
            updateStatus('status-ready', 'éŸ³ä¹å·²æš‚åœ');
            updateButtons();
            stopTimeUpdater();
        });
        
        audio.addEventListener('error', (e) => {
            updateStatus('status-offline', `åŠ è½½å¤±è´¥: ${getAudioError(audio.error)}`);
            state.music = null;
            updateButtons();
        });
        
        audio.addEventListener('ended', () => {
            state.isPlaying = false;
            updateStatus('status-ready', 'æ’­æ”¾å®Œæˆ');
            updateButtons();
            stopTimeUpdater();
        });
        
        state.music = audio;
        return audio;
    }
    
    function getAudioError(error) {
        if (!error) return 'æœªçŸ¥é”™è¯¯';
        
        switch(error.code) {
            case error.MEDIA_ERR_ABORTED:
                return 'æ’­æ”¾è¢«ä¸­æ­¢';
            case error.MEDIA_ERR_NETWORK:
                return 'ç½‘ç»œé”™è¯¯';
            case error.MEDIA_ERR_DECODE:
                return 'æ–‡ä»¶è§£ç é”™è¯¯';
            case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
                return 'æ–‡ä»¶æ ¼å¼ä¸æ”¯æŒ';
            default:
                return 'åŠ è½½å¤±è´¥';
        }
    }
    
    function playMusic() {
        if (!state.music) {
            tryLocalFile();
            return;
        }
        
        state.music.play().catch(error => {
            updateStatus('status-offline', 'éœ€è¦ç”¨æˆ·ç‚¹å‡»æ‰èƒ½æ’­æ”¾');
        });
    }
    
    function pauseMusic() {
        if (state.music) {
            state.music.pause();
        }
    }
    
    // ====== æ—¶é—´æ›´æ–°å™¨ ======
    let timeUpdater = null;
    
    function startTimeUpdater() {
        stopTimeUpdater();
        timeUpdater = setInterval(updateTime, 500);
    }
    
    function stopTimeUpdater() {
        if (timeUpdater) {
            clearInterval(timeUpdater);
            timeUpdater = null;
        }
    }
    
    // ====== éŸ³ä¹æºé€‰æ‹© ======
    function tryLocalFile() {
        updateStatus('status-loading', 'å°è¯•åŠ è½½æœ¬åœ°æ–‡ä»¶...');
        
        let tried = 0;
        
        function tryNextFile() {
            if (tried >= MUSIC_CONFIG.localFiles.length) {
                updateStatus('status-offline', 'æœ¬åœ°æ–‡ä»¶å¤±è´¥ï¼Œå°è¯•åœ¨çº¿éŸ³ä¹');
                setTimeout(() => useOnlineMusic(), 1000);
                return;
            }
            
            const file = MUSIC_CONFIG.localFiles[tried];
            const audio = createAudioPlayer(file);
            audio.load();
            
            setTimeout(() => {
                if (state.music && state.music.readyState === 0) {
                    tried++;
                    tryNextFile();
                }
            }, 2000);
            
            tried++;
        }
        
        tryNextFile();
    }
    
    function useOnlineMusic() {
        updateStatus('status-loading', 'åŠ è½½åœ¨çº¿éŸ³ä¹...');
        
        const onlineSrc = MUSIC_CONFIG.onlineSources[0];
        const audio = createAudioPlayer(onlineSrc);
        audio.load();
        
        elements.onlineBtn.innerHTML = 'âœ“ åœ¨çº¿';
        setTimeout(() => {
            elements.onlineBtn.disabled = false;
            elements.onlineBtn.innerHTML = 'ğŸŒ åœ¨çº¿';
        }, 5000);
    }
    
    // ====== çƒŸèŠ±ç³»ç»Ÿ - ä¿®æ”¹æ–‡å­—é¢œè‰²ä¸ºç™½è‰² ======
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;
    
    const particleSize = 3;
    const particleGap = 6;
    
    let particles = [];
    let fireworks = [];
    
    // ç¥ç¦è¯­ - æ–‡å­—é¢œè‰²æ”¹ä¸ºç™½è‰²
    const textSequence = [
        { text: "å†è§ 2025", time: 2500 },
        { text: "3", time: 1000 },
        { text: "2", time: 1000 },
        { text: "1", time: 1000 },
        { text: "2026", time: 3500 },
        { text: "æ–°å¹´å¿«ä¹", time: 3500 },
        { text: "ä¸‡äº‹å¦‚æ„", time: 3000 },
        { text: "èº«ä½“å¥åº·", time: 3000 },
        { text: "å¿ƒæƒ³äº‹æˆ", time: 3000 },
        { text: "è´¢æºå¹¿è¿›", time: 3000 },
        { text: "é˜–å®¶å¹¸ç¦", time: 3000 },
        { text: "ç¬‘å£å¸¸å¼€", time: 3000 },
        { text: "å¥½è¿è¿è¿", time: 3000 },
        { text: "2026 ä¸€åˆ‡é¡ºåˆ©", time: 4000 },
        { text: "æ–°å¹´å¿«ä¹", time: 5000 }
    ];
    
    let currentStep = 0;
    let lastStepTime = Date.now();
    let isInitialized = false;
    
    // ç²’å­ç±» - ä¿®æ”¹ç²’å­é¢œè‰²ä¸ºç™½è‰²
    class Particle {
        constructor(x, y) {
            this.x = Math.random() * width;
            this.y = Math.random() * height;
            this.targetX = x;
            this.targetY = y;
            this.color = '#FFFFFF'; // æ”¹ä¸ºç™½è‰²
            this.size = particleSize;
        }
        
        update() {
            const dx = this.targetX - this.x;
            const dy = this.targetY - this.y;
            this.x += dx * 0.08;
            this.y += dy * 0.08;
        }
        
        draw() {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
            ctx.fill();
        }
    }
    
    // çƒŸèŠ±ç±»
    class Firework {
        constructor(x, y) {
            this.x = x || Math.random() * width;
            this.y = y || height;
            this.targetY = Math.random() * (height / 2);
            this.speed = Math.random() * 3 + 4;
            this.color = `hsl(${Math.random() * 360}, 100%, 60%)`;
            this.particles = [];
            this.exploded = false;
        }

        update() {
            if (!this.exploded) {
                this.y -= this.speed;
                if (this.y <= this.targetY) {
                    this.explode();
                    if (state.isPlaying) {
                        playFireSound();
                    }
                }
            } else {
                this.particles.forEach(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.05;
                    p.alpha -= 0.02;
                });
                this.particles = this.particles.filter(p => p.alpha > 0);
            }
        }

        explode() {
            this.exploded = true;
            for (let i = 0; i < 60; i++) {
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 4 + 2;
                this.particles.push({
                    x: this.x,
                    y: this.y,
                    vx: Math.cos(angle) * speed,
                    vy: Math.sin(angle) * speed,
                    color: this.color,
                    alpha: 1,
                    size: Math.random() * 2 + 1
                });
            }
        }

        draw() {
            if (!this.exploded) {
                ctx.fillStyle = this.color;
                ctx.fillRect(this.x, this.y, 3, 10);
            } else {
                this.particles.forEach(p => {
                    ctx.globalAlpha = p.alpha;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;
            }
        }
    }
    
    // çƒŸèŠ±éŸ³æ•ˆ
    function playFireSound() {
        try {
            const fireSound = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-firework-explosion-3097.mp3');
            fireSound.volume = 0.2;
            fireSound.play().catch(() => {});
        } catch (e) {}
    }
    
    function createFirework(x, y) {
        fireworks.push(new Firework(x, y));
    }
    
    // æ–‡å­—ç²’å­ç³»ç»Ÿ - ä¿®æ”¹æ–‡å­—é¢œè‰²ä¸ºç™½è‰²
    function createTextParticles(text) {
        const offCanvas = document.createElement('canvas');
        const offCtx = offCanvas.getContext('2d');
        offCanvas.width = width;
        offCanvas.height = height;
        
        let fontSize = Math.min(150, width / 8);
        if (text.length > 4) fontSize *= 0.7;

        offCtx.font = `bold ${fontSize}px Microsoft YaHei`;
        offCtx.fillStyle = '#FFFFFF'; // æ”¹ä¸ºç™½è‰²
        offCtx.textAlign = 'center';
        offCtx.textBaseline = 'middle';
        offCtx.fillText(text, width / 2, height / 2);
        
        const imageData = offCtx.getImageData(0, 0, width, height).data;
        const targets = [];
        
        for (let y = 0; y < height; y += particleGap) {
            for (let x = 0; x < width; x += particleGap) {
                const index = (y * width + x) * 4;
                if (imageData[index + 3] > 128) {
                    targets.push({ x, y });
                }
            }
        }
        
        return targets;
    }
    
    function updateParticles(text) {
        const targets = createTextParticles(text);
        
        if (targets.length > particles.length) {
            for (let i = particles.length; i < targets.length; i++) {
                particles.push(new Particle(width / 2, height / 2));
            }
        }
        
        particles.forEach((p, i) => {
            if (targets[i]) {
                p.targetX = targets[i].x;
                p.targetY = targets[i].y;
                p.color = '#FFFFFF'; // ç¡®ä¿ç²’å­é¢œè‰²ä¸ºç™½è‰²
            }
        });
        
        if (targets.length < particles.length) {
            particles.splice(targets.length);
        }
    }
    
    // ä¸»åŠ¨ç”»å¾ªç¯
    function animate() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.2)';
        ctx.fillRect(0, 0, width, height);
        
        // æ›´æ–°æ–‡å­—
        const now = Date.now();
        if (now - lastStepTime > textSequence[currentStep].time) {
            currentStep = (currentStep + 1) % textSequence.length;
            lastStepTime = now;
            updateParticles(textSequence[currentStep].text);
            
            // åˆ‡æ¢æ–‡å­—æ—¶æ”¾çƒŸèŠ±
            for (let i = 0; i < 3; i++) {
                setTimeout(() => createFirework(), i * 200);
            }
        }
        
        // æ›´æ–°ç²’å­
        particles.forEach(p => {
            p.update();
            p.draw();
        });
        
        // æ›´æ–°çƒŸèŠ±
        fireworks.forEach(f => {
            f.update();
            f.draw();
        });
        
        // éšæœºçƒŸèŠ±
        if (Math.random() < 0.03 && state.isPlaying) {
            createFirework();
        }
        
        // æ¸…ç†å®Œæˆçš„çƒŸèŠ±
        fireworks = fireworks.filter(f => !f.exploded || f.particles.length > 0);
        
        requestAnimationFrame(animate);
    }
    
    // åˆå§‹åŒ–
    function init() {
        updateParticles(textSequence[0].text);
        isInitialized = true;
        
        // åˆå§‹çƒŸèŠ±
        for (let i = 0; i < 3; i++) {
            setTimeout(() => createFirework(), i * 400);
        }
        
        animate();
    }
    
    // ====== é¡µé¢å¯åŠ¨ ======
    window.addEventListener('load', function() {
        // åˆå§‹åŒ–çƒŸèŠ±ç³»ç»Ÿ
        setTimeout(init, 500);
        
        // è‡ªåŠ¨å°è¯•åŠ è½½æœ¬åœ°éŸ³ä¹
        setTimeout(() => {
            tryLocalFile();
        }, 1000);
        
        // ç‚¹å‡»å±å¹•æ§åˆ¶
        canvas.addEventListener('click', function(e) {
            if (!state.isPlaying && state.music) {
                playMusic();
            }
            createFirework(e.clientX, e.clientY);
        });
        
        // çª—å£å¤§å°è°ƒæ•´
        window.addEventListener('resize', () => {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
            if (isInitialized) updateParticles(textSequence[currentStep].text);
        });
        
        // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        canvas.addEventListener('touchstart', function(e) {
            e.preventDefault();
            if (!state.isPlaying && state.music) {
                playMusic();
            }
            const touch = e.touches[0];
            createFirework(touch.clientX, touch.clientY);
        });
    });
</script>
</body>
</html>
